<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Player Pro - Enhanced Edition</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>üéπ MIDI Player Pro - Enhanced Edition</h1>
        <div class="subtitle">Powered by Tone.js ‚Ä¢ 128 Instruments ‚Ä¢ Professional Effects</div>
        
        <div class="tabs">
            <button class="tab active" data-tab="player">‚ñ∂ –ü–ª–µ–µ—Ä</button>
            <button class="tab" data-tab="export">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="tab" data-tab="import">üì• –°–æ–∑–¥–∞—Ç—å</button>
            <button class="tab" data-tab="record">üéôÔ∏è –ó–∞–ø–∏—Å—å</button>
        </div>

        <!-- TAB 1: –ü–õ–ï–ï–† -->
        <div class="tab-content active" id="player">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üéµ</div>
                <div class="upload-text">
                    –ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ MIDI —Ñ–∞–π–ª —Å—é–¥–∞
                </div>
            </div>
            
            <input type="file" id="fileInput" accept=".mid,.midi">
            
            <div class="file-info" id="fileInfo">
                <div class="file-name" id="fileName"></div>
                <div class="info-box" id="midiInfo"></div>
                <div class="tempo-info" id="tempoInfo" style="display: none;"></div>
            </div>

            <div class="visualizer" id="visualizer">
                <canvas id="canvas"></canvas>
                <div class="viz-debug" id="vizDebug">–ù–æ—Ç: 0</div>
            </div>

            <div class="visualization-mode" id="visualizationMode">
                <button class="viz-btn selected" data-mode="bars">üìä –°—Ç–æ–ª–±—Ü—ã</button>
                <button class="viz-btn" data-mode="wave">üåä –í–æ–ª–Ω–∞</button>
                <button class="viz-btn" data-mode="circle">‚≠ï –ö—Ä—É–≥</button>
            </div>

            <!-- –°–µ–ª–µ–∫—Ç–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ - –í–°–ï 128 –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í GENERAL MIDI -->
            <div class="instrument-selector" id="instrumentSelector">
                <label for="instrumentType">üéº –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (General MIDI - 128 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤):</label>
                <select id="instrumentType">
                    <optgroup label="üéπ PIANO (0-7)">
                        <option value="acoustic-grand-piano" selected>0: Acoustic Grand Piano</option>
                        <option value="bright-acoustic-piano">1: Bright Acoustic Piano</option>
                        <option value="electric-grand-piano">2: Electric Grand Piano</option>
                        <option value="honky-tonk-piano">3: Honky-tonk Piano</option>
                        <option value="electric-piano-1">4: Electric Piano 1</option>
                        <option value="electric-piano-2">5: Electric Piano 2</option>
                        <option value="harpsichord">6: Harpsichord</option>
                        <option value="clavinet">7: Clavinet</option>
                    </optgroup>
                    
                    <optgroup label="üéº CHROMATIC PERCUSSION (8-15)">
                        <option value="celesta">8: Celesta</option>
                        <option value="glockenspiel">9: Glockenspiel</option>
                        <option value="music-box">10: Music Box</option>
                        <option value="vibraphone">11: Vibraphone</option>
                        <option value="marimba">12: Marimba</option>
                        <option value="xylophone">13: Xylophone</option>
                        <option value="tubular-bells">14: Tubular Bells</option>
                        <option value="dulcimer">15: Dulcimer</option>
                    </optgroup>
                    
                    <optgroup label="üéπ ORGAN (16-23)">
                        <option value="drawbar-organ">16: Drawbar Organ</option>
                        <option value="percussive-organ">17: Percussive Organ</option>
                        <option value="rock-organ">18: Rock Organ</option>
                        <option value="church-organ">19: Church Organ</option>
                        <option value="reed-organ">20: Reed Organ</option>
                        <option value="accordion">21: Accordion</option>
                        <option value="harmonica">22: Harmonica</option>
                        <option value="tango-accordion">23: Tango Accordion</option>
                    </optgroup>
                    
                    <optgroup label="üé∏ GUITAR (24-31)">
                        <option value="nylon-string-guitar">24: Nylon String Guitar</option>
                        <option value="steel-string-guitar">25: Steel String Guitar</option>
                        <option value="jazz-guitar">26: Jazz Guitar</option>
                        <option value="clean-guitar">27: Clean Guitar</option>
                        <option value="muted-guitar">28: Muted Guitar</option>
                        <option value="overdriven-guitar">29: Overdriven Guitar</option>
                        <option value="distortion-guitar">30: Distortion Guitar</option>
                        <option value="guitar-harmonics">31: Guitar Harmonics</option>
                    </optgroup>
                    
                    <optgroup label="üé∏ BASS (32-39)">
                        <option value="acoustic-bass">32: Acoustic Bass</option>
                        <option value="fingered-bass">33: Fingered Bass</option>
                        <option value="picked-bass">34: Picked Bass</option>
                        <option value="fretless-bass">35: Fretless Bass</option>
                        <option value="slap-bass-1">36: Slap Bass 1</option>
                        <option value="slap-bass-2">37: Slap Bass 2</option>
                        <option value="synth-bass-1">38: Synth Bass 1</option>
                        <option value="synth-bass-2">39: Synth Bass 2</option>
                    </optgroup>
                    
                    <optgroup label="üéª STRINGS (40-47)">
                        <option value="violin">40: Violin</option>
                        <option value="viola">41: Viola</option>
                        <option value="cello">42: Cello</option>
                        <option value="contrabass">43: Contrabass</option>
                        <option value="tremolo-strings">44: Tremolo Strings</option>
                        <option value="pizzicato-strings">45: Pizzicato Strings</option>
                        <option value="orchestral-harp">46: Orchestral Harp</option>
                        <option value="timpani">47: Timpani</option>
                    </optgroup>
                    
                    <optgroup label="üéº ENSEMBLE (48-55)">
                        <option value="string-ensemble-1">48: String Ensemble 1</option>
                        <option value="string-ensemble-2">49: String Ensemble 2</option>
                        <option value="synth-strings-1">50: Synth Strings 1</option>
                        <option value="synth-strings-2">51: Synth Strings 2</option>
                        <option value="choir-aahs">52: Choir Aahs</option>
                        <option value="voice-oohs">53: Voice Oohs</option>
                        <option value="synth-choir">54: Synth Choir</option>
                        <option value="orchestra-hit">55: Orchestra Hit</option>
                    </optgroup>
                    
                    <optgroup label="üé∫ BRASS (56-63)">
                        <option value="trumpet">56: Trumpet</option>
                        <option value="trombone">57: Trombone</option>
                        <option value="tuba">58: Tuba</option>
                        <option value="muted-trumpet">59: Muted Trumpet</option>
                        <option value="french-horn">60: French Horn</option>
                        <option value="brass-section">61: Brass Section</option>
                        <option value="synth-brass-1">62: Synth Brass 1</option>
                        <option value="synth-brass-2">63: Synth Brass 2</option>
                    </optgroup>
                    
                    <optgroup label="üé∑ REED (64-71)">
                        <option value="soprano-sax">64: Soprano Sax</option>
                        <option value="alto-sax">65: Alto Sax</option>
                        <option value="tenor-sax">66: Tenor Sax</option>
                        <option value="baritone-sax">67: Baritone Sax</option>
                        <option value="oboe">68: Oboe</option>
                        <option value="english-horn">69: English Horn</option>
                        <option value="bassoon">70: Bassoon</option>
                        <option value="clarinet">71: Clarinet</option>
                    </optgroup>
                    
                    <optgroup label="üé∂ PIPE (72-79)">
                        <option value="piccolo">72: Piccolo</option>
                        <option value="flute">73: Flute</option>
                        <option value="recorder">74: Recorder</option>
                        <option value="pan-flute">75: Pan Flute</option>
                        <option value="blown-bottle">76: Blown Bottle</option>
                        <option value="shakuhachi">77: Shakuhachi</option>
                        <option value="whistle">78: Whistle</option>
                        <option value="ocarina">79: Ocarina</option>
                    </optgroup>
                    
                    <optgroup label="üéπ SYNTH LEAD (80-87)">
                        <option value="lead-square">80: Lead 1 (square)</option>
                        <option value="lead-sawtooth">81: Lead 2 (sawtooth)</option>
                        <option value="lead-calliope">82: Lead 3 (calliope)</option>
                        <option value="lead-chiff">83: Lead 4 (chiff)</option>
                        <option value="lead-charang">84: Lead 5 (charang)</option>
                        <option value="lead-voice">85: Lead 6 (voice)</option>
                        <option value="lead-fifths">86: Lead 7 (fifths)</option>
                        <option value="lead-bass">87: Lead 8 (bass + lead)</option>
                    </optgroup>
                    
                    <optgroup label="üéπ SYNTH PAD (88-95)">
                        <option value="pad-new-age">88: Pad 1 (new age)</option>
                        <option value="pad-warm">89: Pad 2 (warm)</option>
                        <option value="pad-polysynth">90: Pad 3 (polysynth)</option>
                        <option value="pad-choir">91: Pad 4 (choir)</option>
                        <option value="pad-bowed">92: Pad 5 (bowed)</option>
                        <option value="pad-metallic">93: Pad 6 (metallic)</option>
                        <option value="pad-halo">94: Pad 7 (halo)</option>
                        <option value="pad-sweep">95: Pad 8 (sweep)</option>
                    </optgroup>
                    
                    <optgroup label="‚ú® SYNTH EFFECTS (96-103)">
                        <option value="fx-rain">96: FX 1 (rain)</option>
                        <option value="fx-soundtrack">97: FX 2 (soundtrack)</option>
                        <option value="fx-crystal">98: FX 3 (crystal)</option>
                        <option value="fx-atmosphere">99: FX 4 (atmosphere)</option>
                        <option value="fx-brightness">100: FX 5 (brightness)</option>
                        <option value="fx-goblins">101: FX 6 (goblins)</option>
                        <option value="fx-echoes">102: FX 7 (echoes)</option>
                        <option value="fx-sci-fi">103: FX 8 (sci-fi)</option>
                    </optgroup>
                    
                    <optgroup label="üåç ETHNIC (104-111)">
                        <option value="sitar">104: Sitar</option>
                        <option value="banjo">105: Banjo</option>
                        <option value="shamisen">106: Shamisen</option>
                        <option value="koto">107: Koto</option>
                        <option value="kalimba">108: Kalimba</option>
                        <option value="bagpipe">109: Bag pipe</option>
                        <option value="fiddle">110: Fiddle</option>
                        <option value="shanai">111: Shanai</option>
                    </optgroup>
                    
                    <optgroup label="ü•Å PERCUSSIVE (112-119)">
                        <option value="tinkle-bell">112: Tinkle Bell</option>
                        <option value="agogo">113: Agogo</option>
                        <option value="steel-drums">114: Steel Drums</option>
                        <option value="woodblock">115: Woodblock</option>
                        <option value="taiko-drum">116: Taiko Drum</option>
                        <option value="melodic-tom">117: Melodic Tom</option>
                        <option value="synth-drum">118: Synth Drum</option>
                        <option value="reverse-cymbal">119: Reverse Cymbal</option>
                    </optgroup>
                    
                    <optgroup label="üîä SOUND EFFECTS (120-127)">
                        <option value="guitar-fret-noise">120: Guitar Fret Noise</option>
                        <option value="breath-noise">121: Breath Noise</option>
                        <option value="seashore">122: Seashore</option>
                        <option value="bird-tweet">123: Bird Tweet</option>
                        <option value="telephone-ring">124: Telephone Ring</option>
                        <option value="helicopter">125: Helicopter</option>
                        <option value="applause">126: Applause</option>
                        <option value="gunshot">127: Gunshot</option>
                    </optgroup>
                </select>
            </div>

            <!-- –°–µ–∫—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ -->
            <div class="effects-section" id="effectsSection">
                <h3>üéõÔ∏è –ê—É–¥–∏–æ –≠—Ñ—Ñ–µ–∫—Ç—ã</h3>
                
                <div class="effect-controls">
                    <div class="effect-group">
                        <label>
                            <input type="checkbox" id="reverbEnabled" class="effect-toggle">
                            üåä –†–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—è
                        </label>
                        <div class="effect-params" id="reverbParams" style="display: none;">
                            <div class="slider-control-small">
                                <span>–†–∞–∑–º–µ—Ä:</span>
                                <input type="range" id="reverbDecay" min="0.1" max="10" value="2.5" step="0.1">
                                <span id="reverbDecayValue">2.5</span>
                            </div>
                            <div class="slider-control-small">
                                <span>–£—Ä–æ–≤–µ–Ω—å:</span>
                                <input type="range" id="reverbWet" min="0" max="100" value="30">
                                <span id="reverbWetValue">30%</span>
                            </div>
                        </div>
                    </div>

                    <div class="effect-group">
                        <label>
                            <input type="checkbox" id="chorusEnabled" class="effect-toggle">
                            üéµ –•–æ—Ä—É—Å
                        </label>
                        <div class="effect-params" id="chorusParams" style="display: none;">
                            <div class="slider-control-small">
                                <span>–ì–ª—É–±–∏–Ω–∞:</span>
                                <input type="range" id="chorusDepth" min="0" max="1" value="0.5" step="0.01">
                                <span id="chorusDepthValue">0.5</span>
                            </div>
                            <div class="slider-control-small">
                                <span>–ß–∞—Å—Ç–æ—Ç–∞:</span>
                                <input type="range" id="chorusFrequency" min="0.1" max="10" value="2.5" step="0.1">
                                <span id="chorusFrequencyValue">2.5 Hz</span>
                            </div>
                        </div>
                    </div>

                    <div class="effect-group">
                        <label>
                            <input type="checkbox" id="delayEnabled" class="effect-toggle">
                            ‚è±Ô∏è –î–∏–ª–µ–π
                        </label>
                        <div class="effect-params" id="delayParams" style="display: none;">
                            <div class="slider-control-small">
                                <span>–í—Ä–µ–º—è:</span>
                                <input type="range" id="delayTime" min="0.01" max="1" value="0.25" step="0.01">
                                <span id="delayTimeValue">0.25s</span>
                            </div>
                            <div class="slider-control-small">
                                <span>–ü–æ–≤—Ç–æ—Ä—ã:</span>
                                <input type="range" id="delayFeedback" min="0" max="0.9" value="0.3" step="0.01">
                                <span id="delayFeedbackValue">0.3</span>
                            </div>
                        </div>
                    </div>

                    <div class="effect-group">
                        <label>
                            <input type="checkbox" id="distortionEnabled" class="effect-toggle">
                            üî• –î–∏—Å—Ç–æ—Ä—à–Ω
                        </label>
                        <div class="effect-params" id="distortionParams" style="display: none;">
                            <div class="slider-control-small">
                                <span>–£—Ä–æ–≤–µ–Ω—å:</span>
                                <input type="range" id="distortionAmount" min="0" max="1" value="0.4" step="0.01">
                                <span id="distortionAmountValue">0.4</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="slider-control" id="volumeControl">
                <span class="slider-label">üîä –ì—Ä–æ–º–∫–æ—Å—Ç—å:</span>
                <input type="range" id="volumeSlider" min="0" max="100" value="70">
                <span class="slider-value" id="volumeValue">70%</span>
            </div>

            <div class="slider-control" id="tempoControl">
                <span class="slider-label">‚è±Ô∏è –¢–µ–º–ø:</span>
                <input type="range" id="tempoSlider" min="25" max="300" value="100" step="5">
                <span class="slider-value" id="tempoValue">100%</span>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>
            
            <div class="controls">
                <button id="playBtn" disabled>
                    <span>‚ñ∂</span> –ò–≥—Ä–∞—Ç—å
                </button>
                <button id="pauseBtn" disabled>
                    <span>‚è∏</span> –ü–∞—É–∑–∞
                </button>
                <button id="stopBtn" disabled>
                    <span>‚èπ</span> –°—Ç–æ–ø
                </button>
            </div>
            
            <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∏—Ç–µ MIDI —Ñ–∞–π–ª –¥–ª—è –Ω–∞—á–∞–ª–∞</div>
        </div>

        <!-- TAB 2: –≠–ö–°–ü–û–†–¢ -->
        <div class="tab-content" id="export">
            <div class="help-text">
                <h3>üì§ –≠–∫—Å–ø–æ—Ä—Ç MIDI –≤ JSON/WAV</h3>
                <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ MIDI —Ñ–∞–π–ª –≤ –ø–ª–µ–µ—Ä–µ, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞.</p>
            </div>

            <div class="controls">
                <button id="exportJsonBtn" disabled>
                    <span>üì•</span> –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ JSON
                </button>
                <button id="exportWavBtn" class="secondary" disabled>
                    <span>üéµ</span> –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ WAV
                </button>
            </div>

            <div class="json-editor">
                <label>JSON –¥–∞–Ω–Ω—ã–µ:</label>
                <textarea id="jsonOutput" placeholder="JSON –¥–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ —ç–∫—Å–ø–æ—Ä—Ç–∞..." readonly></textarea>
            </div>

            <div class="controls">
                <button id="downloadJsonBtn" class="secondary" disabled>
                    <span>üíæ</span> –°–∫–∞—á–∞—Ç—å JSON
                </button>
            </div>
        </div>

        <!-- TAB 3: –°–û–ó–î–ê–¢–¨ MIDI -->
        <div class="tab-content" id="import">
            <div class="help-text">
                <h3>üì• –°–æ–∑–¥–∞–Ω–∏–µ MIDI –∏–∑ JSON</h3>
                <p>–§–æ—Ä–º–∞—Ç JSON:</p>
                <code>{"tracks": [{"notes": [{"note": 60, "time": 0, "duration": 0.5, "velocity": 100}]}]}</code>
                <p style="margin-top: 10px;"><strong>note:</strong> MIDI –Ω–æ—Ç–∞ (60 = C4), <strong>time:</strong> –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö, <strong>duration:</strong> –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, <strong>velocity:</strong> –≥—Ä–æ–º–∫–æ—Å—Ç—å (0-127)</p>
            </div>

            <div class="upload-area-small" id="jsonUploadArea">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">
                    –ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ JSON —Ñ–∞–π–ª —Å—é–¥–∞
                </div>
            </div>
            
            <input type="file" id="jsonFileInput" accept=".json">

            <div class="json-editor">
                <label>–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ JSON –≤—Ä—É—á–Ω—É—é:</label>
                <textarea id="jsonInput" placeholder='{"tracks": [{"notes": [{"note": 60, "time": 0, "duration": 0.5, "velocity": 100}]}]}'></textarea>
            </div>

            <div class="controls">
                <button id="createMidiBtn">
                    <span>üéµ</span> –°–æ–∑–¥–∞—Ç—å MIDI —Ñ–∞–π–ª
                </button>
                <button id="previewMidiBtn" class="secondary">
                    <span>‚ñ∂</span> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                </button>
            </div>

            <div class="status" id="importStatus"></div>
        </div>

        <!-- TAB 4: –ó–ê–ü–ò–°–¨ -->
        <div class="tab-content" id="record">
            <div class="help-text">
                <h3>üéôÔ∏è –ó–∞–ø–∏—Å—å –≤ –∞—É–¥–∏–æ —Ñ–∞–π–ª</h3>
                <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ MIDI —Ñ–∞–π–ª –≤ –ø–ª–µ–µ—Ä–µ, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å" –∏ "–ò–≥—Ä–∞—Ç—å". –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å".</p>
            </div>

            <div class="recording-indicator" id="recordingIndicator">
                ‚ö´ –ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...
            </div>

            <div class="controls">
                <button id="startRecordBtn" disabled>
                    <span>‚ö´</span> –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
                </button>
                <button id="stopRecordBtn" disabled>
                    <span>‚èπ</span> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
                </button>
            </div>

            <div class="controls">
                <button id="downloadAudioBtn" class="secondary" disabled>
                    <span>üíæ</span> –°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ (WAV)
                </button>
            </div>

            <div class="status" id="recordStatus">–ó–∞–≥—Ä—É–∑–∏—Ç–µ MIDI —Ñ–∞–π–ª –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏</div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tone.js –∏–∑ CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ -->
    <script src="js/sampler-instruments.js"></script>
    <script src="js/config.js"></script>
    <script src="js/midi-parser.js"></script>
    <script src="js/midi-writer.js"></script>
    <script src="js/visualizer.js"></script>
    <script src="js/audio-effects.js"></script>
    <script src="js/midi-player.js"></script>
    <script src="js/ui-controller.js"></script>
    <script src="js/main.js"></script>
</body>
</html>